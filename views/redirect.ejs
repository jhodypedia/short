<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Mengalihkan...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body class="page page-redirect">
<div class="bg-gradient"></div>

<div id="adblock-overlay" class="adblock-overlay" style="display: none;">
    <div class="adblock-box">
        <h2>AdBlock Terdeteksi</h2>
        <p>Silakan nonaktifkan AdBlock untuk melanjutkan.</p>
        <p>Refresh halaman setelah menonaktifkan AdBlock.</p>
    </div>
</div>

<main class="container redirect-container">
    <section class="card glass card-redirect">

        <!-- SPONSORED CONTENT BANNER -->
        <div class="sponsor-banner">
            <div class="sponsor-label">Sponsored Content</div>
            <div class="sponsor-inner">
                <script type="text/javascript">
                    atOptions = {
                        'key' : 'fea41e5f8bbdf475847093a76298a876',
                        'format' : 'iframe',
                        'height' : 90,
                        'width' : 728,
                        'params' : {}
                    };
                </script>
                <script type="text/javascript" src="//www.highperformanceformat.com/fea41e5f8bbdf475847093a76298a876/invoke.js"></script>
            </div>
        </div>

        <h1 class="title">Sebentar ya…</h1>
        <p class="subtitle" id="subtitle-text">Klik tombol di bawah, lihat iklan sebentar, lalu klik sekali lagi untuk lanjut ke tujuan.</p>

        <!-- BOX IKLAN UTAMA -->
        <div class="ad-wrapper">
            <h2 class="ad-title">Sponsored Content</h2>
            <div class="ad-box" id="ad-box">
                <!-- SCRIPT IKLAN UTAMA (1x saja) -->
                <script type="text/javascript" src="//pl27528697.effectivegatecpm.com/fd/5a/08/fd5a08e141beade9d62603a0b39dd5c8.js"></script>
            </div>
        </div>

        <!-- BUTTON -->
        <button id="continueBtn" class="btn btn-primary btn-continue">
            <span id="spinner" class="spinner" style="display:none;"></span>
            <span id="btn-text">Lanjutkan</span>
        </button>

        <p class="hint small" id="hint-text">Klik pertama memuat iklan. Klik kedua membawa kamu ke URL tujuan.</p>
    </section>
</main>


<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
(function () {
    const code = '<%= code %>';
    const seenKey = 'seen_' + code; 
    let clickedOnce = false;

    // Detect AdBlock
    function detectAdBlock() {
        const bait = document.createElement('div');
        bait.className = 'adsbox';
        bait.style.position = 'absolute';
        bait.style.left = '-9999px';
        document.body.appendChild(bait);

        const blocked = window.getComputedStyle(bait).display === 'none';
        document.body.removeChild(bait);

        if (blocked) {
            document.getElementById('adblock-overlay').style.display = 'flex';
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        setTimeout(detectAdBlock, 800);

        const btn = document.getElementById('continueBtn');
        const spinner = document.getElementById('spinner');
        const btnText = document.getElementById('btn-text');
        const subtitle = document.getElementById('subtitle-text');

        // Jika user sudah pernah lihat iklan → langsung redirect
        if (localStorage.getItem(seenKey) === '1') {
            return doRedirect();
        }

        btn.addEventListener('click', function (e) {
            e.preventDefault();

            if (document.getElementById('adblock-overlay').style.display === 'flex') {
                alert("Nonaktifkan AdBlock untuk melanjutkan.");
                return;
            }

            // KLIK PERTAMA: wajib lihat iklan dulu
            if (!clickedOnce) {
                clickedOnce = true;
                const adBox = document.getElementById('ad-box');
                adBox.scrollIntoView({ behavior: "smooth", block: "center" });

                btnText.textContent = "Lanjutkan ke URL";
                subtitle.textContent = "Scroll lihat iklan di atas, lalu klik tombol ini lagi.";
                return;
            }

            // KLIK KEDUA: lakukan redirect
            btn.classList.add('loading');
            spinner.style.display = 'inline-block';
            btnText.textContent = "Mengalihkan...";

            setTimeout(doRedirect, 700);
        });
    });

    function doRedirect() {
        $.ajax({
            url: '/api/continue/' + encodeURIComponent('<%= code %>'),
            method: 'GET',
            dataType: 'json',
            success: function (res) {
                if (res.success && res.url) {
                    localStorage.setItem(seenKey, '1');
                    window.location.href = res.url;
                } else {
                    alert("Gagal mengalihkan.");
                }
            },
            error: function () {
                alert("Terjadi kesalahan koneksi.");
            }
        });
    }
})();
</script>

</body>
</html>
