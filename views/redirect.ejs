<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Mengalihkan...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body class="page page-redirect">
<div class="bg-gradient"></div>

<div id="adblock-overlay" class="adblock-overlay" style="display:none;">
    <div class="adblock-box">
        <h2>AdBlock Terdeteksi</h2>
        <p>Silakan nonaktifkan AdBlock untuk melanjutkan ke tujuan link.</p>
        <p>Refresh halaman ini setelah menonaktifkan AdBlock.</p>
    </div>
</div>

<main class="container redirect-container">
    <section class="card glass card-redirect">

        <!-- HEADER LABEL SAJA (TANPA IKLAN) -->
        <div class="sponsor-banner">
            <div class="sponsor-label">Sponsored Content</div>
        </div>

        <h1 class="title">Sebentar ya...</h1>
        <p class="subtitle" id="subtitle-text">
            Kamu akan dialihkan ke halaman tujuan. Klik tombol di bawah, lihat iklan sebentar, lalu klik lagi untuk lanjut.
        </p>

        <!-- BOX SPONSORED CONTENT (IKLAN ADA DI SINI) -->
        <div class="ad-wrapper">
            <h2 class="ad-title">Sponsored Content</h2>
            <div class="ad-box" id="ad-box">
                <!-- ====== IKLAN BANNER ADSTERRA (1x) DI DALAM BOX ====== -->
                <div id="ad-inner">
                    <script type="text/javascript">
                        atOptions = {
                            'key' : 'fea41e5f8bbdf475847093a76298a876',
                            'format' : 'iframe',
                            'height' : 90,
                            'width' : 728,
                            'params' : {}
                        };
                    </script>
                    <script type="text/javascript" src="//www.highperformanceformat.com/fea41e5f8bbdf475847093a76298a876/invoke.js"></script>
                </div>
                <!-- ===================================================== -->
            </div>
        </div>

        <button id="continueBtn" class="btn btn-primary btn-continue">
            <span id="spinner" class="spinner" style="display:none;"></span>
            <span id="btn-text">Lanjutkan</span>
        </button>

        <p class="hint small" id="hint-text">
            Klik pertama untuk fokus ke iklan. Klik kedua untuk menuju URL asli.
        </p>
    </section>
</main>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-3fp9G6bT5N2z3N4R0rT7xvFeoJq6Digw1k3jv4mxYyk="
        crossorigin="anonymous"></script>
<script>
    (function () {
        const code = '<%= code %>';
        let clickedOnce = false;

        // Deteksi AdBlock sederhana (bait + cek tinggi ad-box)
        function detectAdBlock() {
            const bait = document.createElement('div');
            bait.className = 'adsbox';
            bait.style.position = 'absolute';
            bait.style.left = '-9999px';
            bait.style.height = '10px';
            bait.style.width = '10px';
            document.body.appendChild(bait);

            const baitBlocked =
                window.getComputedStyle(bait).display === 'none' ||
                bait.offsetHeight === 0 ||
                bait.offsetParent === null;

            document.body.removeChild(bait);

            const adBox = document.getElementById('ad-box');
            const adBoxBlocked = !adBox || adBox.offsetHeight === 0;

            if (baitBlocked || adBoxBlocked) {
                document.getElementById('adblock-overlay').style.display = 'flex';
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(detectAdBlock, 1200);

            const btn = document.getElementById('continueBtn');
            const spinner = document.getElementById('spinner');
            const btnText = document.getElementById('btn-text');
            const subtitle = document.getElementById('subtitle-text');
            const hint = document.getElementById('hint-text');

            btn.addEventListener('click', function (e) {
                e.preventDefault();

                // kalau adblock overlay muncul, paksa matiin dulu
                if (document.getElementById('adblock-overlay').style.display === 'flex') {
                    alert('Harap nonaktifkan AdBlock dan refresh halaman ini.');
                    return;
                }

                // KLIK PERTAMA → fokus ke iklan dalam box
                if (!clickedOnce) {
                    clickedOnce = true;

                    const adBox = document.getElementById('ad-box');
                    if (adBox) {
                        adBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }

                    btnText.textContent = 'Lanjutkan ke URL Asli';
                    subtitle.textContent = 'Silakan lihat/interaksikan iklan di box Sponsored Content, lalu klik tombol ini lagi untuk lanjut.';
                    hint.textContent = 'Klik pertama fokus ke iklan. Klik kedua mengalihkan ke URL asli.';
                    return;
                }

                // KLIK KEDUA → redirect ke URL asli via API
                if (btn.classList.contains('loading')) return;

                btn.classList.add('loading');
                spinner.style.display = 'inline-block';
                btnText.textContent = 'Mengalihkan...';

                setTimeout(doRedirect, 700);
            });
        });

        function doRedirect() {
            $.ajax({
                url: '/api/continue/' + encodeURIComponent(code),
                method: 'GET',
                dataType: 'json',
                success: function (res) {
                    if (res && res.success && res.url) {
                        window.location.href = res.url;
                    } else {
                        alert('Terjadi kesalahan saat mengambil URL tujuan.');
                        const btn = document.getElementById('continueBtn');
                        const spinner = document.getElementById('spinner');
                        const btnText = document.getElementById('btn-text');
                        btn.classList.remove('loading');
                        spinner.style.display = 'none';
                        btnText.textContent = 'Coba Lagi';
                    }
                },
                error: function () {
                    alert('Gagal terhubung ke server.');
                    const btn = document.getElementById('continueBtn');
                    const spinner = document.getElementById('spinner');
                    const btnText = document.getElementById('btn-text');
                    btn.classList.remove('loading');
                    spinner.style.display = 'none';
                    btnText.textContent = 'Coba Lagi';
                }
            });
        }
    })();
</script>

</body>
</html>
