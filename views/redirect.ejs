<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title><%= title %> • Mengalihkan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body class="page page-redirect">
<div class="bg-gradient"></div>

<div id="adblock-overlay" class="adblock-overlay" style="display:none;">
    <div class="adblock-box">
        <h2>Pemeriksaan Diblokir</h2>
        <p>Beberapa pemblokir konten aktif dan mengganggu proses pengecekan tautan.</p>
        <p>Nonaktifkan pemblokir sejenak lalu refresh halaman ini.</p>
    </div>
</div>

<main class="container redirect-container">
    <section class="card glass card-redirect">

        <div class="sponsor-banner">
            <div class="sponsor-label">Sponsored Content</div>
        </div>

        <!-- ARTIKEL / INFORMASI -->
        <article class="link-article">
            <h1 class="title"><%= title %></h1>
            <p class="subtitle" id="subtitle-text">
                Halaman yang kamu minta sedang kami siapkan. Kami menambahkan lapisan informasi di sini
                agar kamu tahu ke mana tautan ini akan membawamu, sekaligus memastikan tautan tetap aktif
                dan dapat diakses tanpa masalah.
            </p>

            <div class="article-body">
                <p>
                    Terkadang sebuah tautan dibagikan berkali-kali melalui chat, media sosial, atau forum.
                    Dengan halaman perantara seperti ini, kamu bisa memiliki sedikit gambaran sebelum benar-benar
                    berpindah ke tujuan utama. Ini membantu mengurangi tautan yang salah klik, rusak, atau
                    mengarah ke halaman yang sudah tidak tersedia.
                </p>
                <p>
                    Jika tautan ini dibagikan oleh seseorang yang kamu kenal atau dari sumber yang kamu percaya,
                    kemungkinan besar kontennya aman untuk diakses. Namun tetaplah berhati-hati saat memasukkan
                    data pribadi, password, atau informasi sensitif di halaman berikutnya. Pastikan alamat situs
                    tujuan terlihat benar dan menggunakan koneksi yang aman (https).
                </p>
                <p>
                    Setelah proses pengecekan singkat selesai, kamu bisa melanjutkan ke halaman tujuan dengan
                    menekan tombol di bawah. Jika halaman tidak terbuka, kamu selalu dapat kembali ke sini dan
                    mencoba lagi.
                </p>
            </div>
        </article>

        <!-- LOADING SEBELUM TOMBOL MUNCUL -->
        <div id="global-loader" style="display:flex;align-items:center;gap:8px;margin:16px 0 8px;font-size:13px;color:#9ca3af;">
            <span class="spinner"></span>
            <span>Memproses tautan dan menyiapkan halaman tujuan…</span>
        </div>

        <!-- BOX SPONSORED CONTENT -->
        <div class="ad-wrapper">
            <h2 class="ad-title">Sponsored Content</h2>
            <div class="ad-box" id="ad-box">
                <div id="ad-inner">
                    <script type="text/javascript">
                        atOptions = {
                            'key' : 'fea41e5f8bbdf475847093a76298a876',
                            'format' : 'iframe',
                            'height' : 90,
                            'width' : 728,
                            'params' : {}
                        };
                    </script>
                    <script type="text/javascript" src="//www.highperformanceformat.com/fea41e5f8bbdf475847093a76298a876/invoke.js"></script>
                </div>
            </div>
        </div>

        <!-- BUTTON, AWALNYA DISEMBUNYIKAN -->
        <button id="continueBtn" class="btn btn-primary btn-continue" style="display:none;">
            <span id="spinner" class="spinner" style="display:none;"></span>
            <span id="btn-text">Lanjutkan</span>
        </button>

        <p class="hint small" id="hint-text">
            Setelah proses singkat ini, kamu akan dialihkan ke halaman tujuan.
        </p>
    </section>
</main>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-3fp9G6bT5N2z3N4R0rT7xvFeoJq6Digw1k3jv4mxYyk="
        crossorigin="anonymous"></script>
<script>
    (function () {
        const code = '<%= code %>';
        // Direct-link iklan (BUKAN .js)
        const adClickUrl = "https://www.effectivegatecpm.com/fsneqkr9s?key=8d8dc55360ed10172b63c2e323f0f59d";
        let clickedOnce = false;

        // Deteksi adblock sederhana
        function detectAdBlock() {
            const bait = document.createElement('div');
            bait.className = 'adsbox';
            bait.style.position = 'absolute';
            bait.style.left = '-9999px';
            bait.style.height = '10px';
            bait.style.width = '10px';
            document.body.appendChild(bait);

            const baitBlocked =
                window.getComputedStyle(bait).display === 'none' ||
                bait.offsetHeight === 0 ||
                bait.offsetParent === null;

            document.body.removeChild(bait);

            const adBox = document.getElementById('ad-box');
            const adBoxBlocked = !adBox || adBox.offsetHeight === 0;

            if (baitBlocked || adBoxBlocked) {
                document.getElementById('adblock-overlay').style.display = 'flex';
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const btn = document.getElementById('continueBtn');
            const spinner = document.getElementById('spinner');
            const btnText = document.getElementById('btn-text');
            const subtitle = document.getElementById('subtitle-text');
            const hint = document.getElementById('hint-text');
            const loader = document.getElementById('global-loader');

            // Jalankan deteksi adblock sedikit terlambat
            setTimeout(detectAdBlock, 1200);

            // Loading sebelum tombol muncul
            setTimeout(function () {
                if (loader) loader.style.display = 'none';
                btn.style.display = 'inline-flex';
                subtitle.textContent = 'Pemeriksaan selesai. Kamu bisa melanjutkan ke halaman tujuan.';
            }, 2000);

            btn.addEventListener('click', function (e) {
                e.preventDefault();

                if (document.getElementById('adblock-overlay').style.display === 'flex') {
                    alert('Pemeriksaan tautan terhalang pemblokir konten. Nonaktifkan dulu lalu refresh.');
                    return;
                }

                // KLIK PERTAMA → buka direct-link iklan di tab baru
                if (!clickedOnce) {
                    clickedOnce = true;

                    try {
                        window.open(adClickUrl, '_blank');
                    } catch (err) {
                        console.error('Popup blocked:', err);
                    }

                    btnText.textContent = 'Buka Halaman';
                    hint.textContent = 'Jika halaman tujuan belum terbuka, tekan tombol satu kali lagi.';
                    return;
                }

                // KLIK KEDUA → redirect ke URL asli via API
                if (btn.classList.contains('loading')) return;

                btn.classList.add('loading');
                spinner.style.display = 'inline-block';
                btnText.textContent = 'Mengalihkan...';

                setTimeout(doRedirect, 700);
            });
        });

        function doRedirect() {
            $.ajax({
                url: '/api/continue/' + encodeURIComponent(code),
                method: 'GET',
                dataType: 'json',
                success: function (res) {
                    console.log('API response:', res);
                    if (res && res.success && res.url) {
                        window.location.href = res.url;
                    } else {
                        resetButton('Terjadi kesalahan, coba lagi.');
                    }
                },
                error: function (xhr, status, err) {
                    console.error('AJAX error:', status, err);
                    resetButton('Gagal terhubung, coba lagi.');
                }
            });
        }

        function resetButton(message) {
            const btn = document.getElementById('continueBtn');
            const spinner = document.getElementById('spinner');
            const btnText = document.getElementById('btn-text');
            const hint = document.getElementById('hint-text');

            if (btn) btn.classList.remove('loading');
            if (spinner) spinner.style.display = 'none';
            if (btnText) btnText.textContent = 'Coba Lagi';
            if (hint && message) hint.textContent = message;
        }
    })();
</script>

</body>
</html>
